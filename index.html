<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredient Expiry Tracker Client</title>
    <style>
        /* Basic Styling for the App */
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f7f7f7;
        }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .container { 
            display: flex; 
            gap: 30px; 
            margin-top: 20px;
        }
        #addForm, #results { 
            background: white;
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            min-height: 300px;
        }
        #addForm { flex: 1; }
        #results { flex: 2; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"] { 
            padding: 10px; 
            margin: 5px 0 15px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
        button { 
            padding: 10px 15px;
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover { 
            background-color: #45a049; 
        }

        h3 { margin-top: 0; color: #4CAF50; }
        .ingredient-item { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee; 
            padding: 10px 0;
        }
        .ingredient-item:last-child { border-bottom: none; }
        
        .expiry-date { 
            font-weight: bold; 
            text-align: right;
        }
        .expired { color: red; }
        .warning { color: orange; }
        .fresh { color: green; }

        /* åˆ é™¤æŒ‰é’®çš„ç‰¹æ®Šæ ·å¼ */
        .delete-btn {
            background-color: #f44336;
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 15px;
            width: auto;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <h1>ğŸ² Ingredient Expiry Tracker</h1>

    <p>ä½¿ç”¨è¡¨å•æ·»åŠ é£Ÿæï¼Œå¹¶ç‚¹å‡»â€œåˆ·æ–°åˆ—è¡¨â€æ¥åŠ è½½å’Œç®¡ç†é£Ÿæã€‚</p>
    
    <div class="container">
        
        <div id="addForm">
            <h3>æ·»åŠ æ–°é£Ÿæ (POST)</h3>
            <label for="name">åç§°:</label>
            <input type="text" id="name" placeholder="ä¾‹å¦‚: Flour" required>

            <label for="amount">æ•°é‡/å•ä½:</label>
            <input type="text" id="amount" placeholder="ä¾‹å¦‚: 500g, 1 Dozen" required>

            <label for="expiryDate">åˆ°æœŸæ—¥:</label>
            <input type="date" id="expiryDate" required>

            <button onclick="postIngredient()">â• æ·»åŠ é£Ÿæ</button>
            <p id="postStatus" style="margin-top: 15px;"></p>
        </div>

        <div id="results">
            <h3>å½“å‰é£Ÿæåˆ—è¡¨ (GET/DELETE)</h3>
            <button onclick="getIngredients()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <div id="ingredientList" style="margin-top: 15px;">
                <p>ç‚¹å‡»â€œåˆ·æ–°åˆ—è¡¨â€åŠ è½½é£Ÿæã€‚</p>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = '/api/ingredients'; 
        const MS_PER_DAY = 1000 * 60 * 60 * 24;

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•°ï¼šè®¡ç®—åˆ°æœŸå¤©æ•° ---
        function getDaysUntilExpiry(dateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const expiry = new Date(dateString);
            expiry.setHours(0, 0, 0, 0);

            // è®¡ç®—å¤©æ•°å·®
            const diffTime = expiry.getTime() - today.getTime();
            return Math.ceil(diffTime / MS_PER_DAY);
        }

        // --- æ¸²æŸ“é£Ÿæåˆ—è¡¨ ---
        function renderIngredients(ingredients) {
            const listDiv = document.getElementById('ingredientList');
            if (ingredients.length === 0) {
                listDiv.innerHTML = '<p>å½“å‰æ²¡æœ‰é£Ÿæè®°å½•ã€‚</p>';
                return;
            }

            // æŒ‰ç…§åˆ°æœŸæ—¥å‡åºæ’åˆ—
            ingredients.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

            listDiv.innerHTML = ingredients.map(item => {
                const daysLeft = getDaysUntilExpiry(item.expiryDate);
                
                let statusClass = 'fresh';
                let statusText = `${daysLeft} å¤©ååˆ°æœŸ`;

                if (daysLeft < 0) {
                    statusClass = 'expired';
                    statusText = `å·²è¿‡æœŸ ${Math.abs(daysLeft)} å¤©`;
                } else if (daysLeft <= 7) {
                    statusClass = 'warning';
                    statusText = `å³å°†åˆ°æœŸ: ${daysLeft} å¤©`;
                }
                
                return `
                    <div class="ingredient-item">
                        <div>
                            <strong>${item.name}</strong> (${item.amount})<br>
                            <small>æ·»åŠ äº: ${item.addedOn}</small>
                        </div>
                        <div class="expiry-date ${statusClass}">
                            ${statusText} (${item.expiryDate})
                            <button class="delete-btn" onclick="deleteIngredient(${item.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- GET Ingredients ---
        async function getIngredients() {
            const listDiv = document.getElementById('ingredientList');
            listDiv.innerHTML = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (response.ok && data.success) {
                    renderIngredients(data.data);
                } else {
                    listDiv.innerHTML = `<p style="color: red;">è·å–æ•°æ®é”™è¯¯: ${data.error || 'æœåŠ¡å™¨é”™è¯¯ã€‚'}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">è¿æ¥ API å¤±è´¥ã€‚</p>`;
                console.error('Fetch error:', error);
            }
        }

        // --- POST Ingredient (ä¿æŒä¸å˜) ---
        async function postIngredient() {
            const name = document.getElementById('name').value;
            const amount = document.getElementById('amount').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const statusP = document.getElementById('postStatus');

            if (!name || !amount || !expiryDate) {
                statusP.style.color = 'orange';
                statusP.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µã€‚';
                return;
            }
            
            statusP.style.color = 'black';
            statusP.textContent = 'æäº¤ä¸­...';

            const payload = { name, amount, expiryDate };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.status === 201 && data.success) {
                    statusP.style.color = 'green';
                    statusP.textContent = `âœ… æˆåŠŸ! å·²æ·»åŠ : ${data.data.name}`;
                    document.getElementById('name').value = '';
                    document.getElementById('amount').value = '';
                    document.getElementById('expiryDate').value = '';
                    getIngredients(); 
                } else if (response.status === 400 && !data.success) {
                    statusP.style.color = 'red';
                    statusP.textContent = `âŒ é”™è¯¯: ${data.error}`;
                } else {
                    statusP.style.color = 'red';
                    statusP.textContent = `å‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚çŠ¶æ€: ${response.status}`;
                }
            } catch (error) {
                statusP.style.color = 'red';
                statusP.textContent = `Post å¤±è´¥ã€‚`;
                console.error('Post error:', error);
            }
        }

        // --- DELETE Ingredient (æ–°å‡½æ•°) ---
        async function deleteIngredient(id) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ID ä¸º ${id} çš„é£Ÿæå—ï¼Ÿ`)) {
                return;
            }

            try {
                // DELETE è¯·æ±‚é€šè¿‡æŸ¥è¯¢å‚æ•°ä¼ é€’ ID
                const response = await fetch(`${API_URL}?id=${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message);
                    getIngredients(); // æˆåŠŸååˆ·æ–°åˆ—è¡¨
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                alert('åˆ é™¤æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°ã€‚');
                console.error('Delete error:', error);
            }
        }


        // Load ingredients on page load
        document.addEventListener('DOMContentLoaded', getIngredients);
    </script>
</body>
</html>
